version: "3"  # ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì˜ ë¬¸ë²• ë²„ì „ì…ë‹ˆë‹¤. (ê·¸ëƒ¥ í‘œì¤€ì´ë¼ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤)

services:     # "ì§€ê¸ˆë¶€í„° ì‹¤í–‰í•  í”„ë¡œê·¸ë¨(ì„œë¹„ìŠ¤) ëª©ë¡ì´ì•¼"
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  # =========================================
  # 2ë²ˆ ì‘ì—…ì: ë°±ì—”ë“œ (Node.js)
  # =========================================
  back:
    # [ë¹Œë“œ ì„¤ì •]
    # -> ë°±ì—”ë“œ ì½”ë“œëŠ” my-node í´ë” ì•ˆì— ìˆì–´. ê±°ê¸°ì„œ ë¹Œë“œí•´.
    build:
      context: ./my-node
      dockerfile: Dockerfile

    # [í¬íŠ¸ ì„¤ì •]
    # -> í”„ë¡ íŠ¸ì—”ë“œê°€(í˜¹ì€ ìš°ë¦¬ê°€) API í˜¸ì¶œí•  ë•Œ ì“¸ 8000ë²ˆ êµ¬ë©ì„ ëš«ì–´ì¤˜.
    ports:
      - "8000:8000" # **ë„ì»¤(ê±´ë¬¼ì£¼)**ì—ê²Œ ë‚´ë¦¬ëŠ” ëª…ë ¹ì…ë‹ˆë‹¤.

    # [ìˆœì„œ ì„¤ì •]
    # -> DBê°€ ì—†ìœ¼ë©´ ë°±ì—”ë“œëŠ” ì¼œì§€ìë§ˆì ì—ëŸ¬ ë‚˜ë‹ˆê¹Œ, dbê°€ ì¼œì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤.
    depends_on:
      - db
      - redis

    # [í™˜ê²½ ë³€ìˆ˜] â­ ì—¬ê¸°ê°€ ì œì¼ ì¤‘ìš”í•©ë‹ˆë‹¤! â­
    # -> Node.js ì½”ë“œ(dbConfig.js)ì—ì„œ process.env.DB_HOST ë¡œ ì½ì–´ê°ˆ ê°’ë“¤.
    environment:
      - PORT=8000 # ë°±ì—”ë“œ í”„ë¡œê·¸ë¨í•œí…Œ "ë„ˆ 8000ë²ˆ ë°©ì— ì„œ ìˆì–´!"ë¼ê³  ì‹œí‚¤ëŠ” ê²ƒ.
      # ì¤‘ìš”: ë„ì»¤ ë‚´ë¶€ë¼ë¦¬ëŠ” 'localhost'ê°€ ì•„ë‹ˆë¼ 'ì„œë¹„ìŠ¤ ì´ë¦„(db)'ì´ ì£¼ì†Œì•¼!
      # ë¡œì»¬ DBì— ì—°ê²°í•˜ê¸° ìœ„í•´ host.docker.internal ì‚¬ìš©
#      - DB_HOST=host.docker.internal
      - DB_HOST=db # ì´ê±´ ë„ì»¤ ë‚´ë¶€ì˜ ë°°í¬ëœ dbì—°ê²° ì‹œ
      - DB_USER=postgres
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=fullstackDB
      - REDIS_HOST=redis

  # =========================================
  # 3ë²ˆ ì‘ì—…ì: ë°ì´í„°docker-compose down -vë² ì´ìŠ¤ (PostgreSQL)
  # =========================================
  db: # ì´ê±° ë„ì»¤ ì´ë¦„ì´ë¼ ë§˜ëŒ€ë¡œ ì„¤ì • ê°€ëŠ¥
    # [ì´ë¯¸ì§€ ì„¤ì •]
    # -> DBëŠ” ìš°ë¦¬ê°€ ì½”ë“œë¥¼ ì§œëŠ” ê²Œ ì•„ë‹ˆë‹ˆê¹Œ, ë‚¨ì´ ë§Œë“  ê³µì‹ ì´ë¯¸ì§€(postgres:18)ë¥¼ ë‹¤ìš´ë°›ì•„ ì¨.
    image: postgres:17

    # [ì´ë¦„ ì„¤ì •]
    # -> í—·ê°ˆë¦¬ë‹ˆê¹Œ ì»¨í…Œì´ë„ˆ ì´ë¦„í‘œë¥¼ 'my-postgres'ë¼ê³  ë”± ë¶™ì—¬ì¤˜.
    container_name: my-postgres

    # [í¬íŠ¸ ì„¤ì •]
    # -> pgAdmin ê°™ì€ íˆ´ë¡œ ë‚´ê°€ ê´€ë¦¬í•´ì•¼ í•˜ë‹ˆê¹Œ 5432ë²ˆ êµ¬ë© ëš«ì–´ì¤˜.
    # ğŸ“Œ 5432ê°€ postgres ì˜ ê¸°ë³¸ í¬íŠ¸ë²ˆí˜¸ ì…ë‹ˆë‹¤. ( "5433(ì™¸ë¶€)ìœ¼ë¡œ ë“¤ì–´ì˜¤ë©´ -> 5432(í¬ìŠ¤íŠ¸ê·¸ë ˆ)ë¡œ ë„£ì–´ì¤˜!" )
    ports:
      - "5433:5432"

    # [í™˜ê²½ ë³€ìˆ˜]
    # -> DB ì¼œì§ˆ ë•Œ ì´ ë¹„ë°€ë²ˆí˜¸ë¡œ ì´ˆê¸° ì„¸íŒ…í•´ì¤˜. (ë°±ì—”ë“œë‘ ë˜‘ê°™ì•„ì•¼ í•¨!)
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: fullstackDB

    # [ë³¼ë¥¨ ì„¤ì •] "ë°ì´í„° ì €ì¥ì†Œ"
    # -> ì»¨í…Œì´ë„ˆê°€ êº¼ì ¸ë„ ë°ì´í„°ê°€ ì‚¬ë¼ì§€ë©´ ì•ˆ ë˜ì–ì•„?
    # -> ë‚´ ì»´í“¨í„°ì˜ ./postgres_data í´ë”ë‘ ë„ì»¤ ì•ˆì˜ ë°ì´í„° í´ë”ë¥¼ ì—°ê²°(ë™ê¸°í™”)í•´.
    # -> (ì´ê±° ì•ˆ í•˜ë©´ ê»ë‹¤ ì¼¤ ë•Œë§ˆë‹¤ íšŒì›ê°€ì… ì •ë³´ ë‹¤ ë‚ ì•„ê°!)
    volumes:
      - ./postgres_data:/var/lib/postgresql/data