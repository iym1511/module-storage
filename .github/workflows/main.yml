name: Full Stack CI/CD
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  # 1단계: 변경 사항 감지
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'my-app/**'
            backend:
              - 'my-node/**'

  # 2단계: 프론트엔드 빌드 (my-app 변경시만 실행)
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./my-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.2'
          cache: 'npm'
          cache-dependency-path: './my-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Success notification
        run: echo "✅ Frontend build completed successfully!"

  # 3단계: 백엔드 배포 (my-node 변경시만 실행)
deploy-backend:
  needs: detect-changes
  if: needs.detect-changes.outputs.backend == 'true'
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # 1️⃣ 백엔드 코드를 EC2로 복사 (my-node 전체)
    - name: Copy backend files to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "my-node/*"
        target: "~/apps/my-node/"

    # 2️⃣ 서버에서 빌드 및 PM2 재시작
    - name: Execute deploy commands on EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/apps/my-node

          # 환경변수 파일 유지
          if [ -f ~/apps/my-node/.env ]; then
            cp ~/apps/my-node/.env .env
          fi

          # 패키지 설치
          npm ci

          # 빌드
          npm run build

          # PM2 재시작
          pm2 restart my-node || pm2 start npm --name "my-node" -- start

          pm2 save

    - name: Verify deployment
      run: |
        sleep 5
        curl -f http://${{ secrets.EC2_HOST }}:8000/health || echo "⚠️ Health check failed"

    - name: Success notification
      run: echo "✅ Backend deployed successfully to EC2!"