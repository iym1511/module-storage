name: Full Stack CI/CD
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  # 1ë‹¨ê³„: ë³€ê²½ ì‚¬í•­ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'my-app/**'
            backend:
              - 'my-node/**'

  # 2ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (my-app ë³€ê²½ì‹œë§Œ ì‹¤í–‰)
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./my-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.2'
          cache: 'npm'
          cache-dependency-path: './my-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Success notification
        run: echo "âœ… Frontend build completed successfully!"

  # 3ë‹¨ê³„: ë°±ì—”ë“œ ë°°í¬ (my-node ë³€ê²½ì‹œë§Œ ì‹¤í–‰)
  # 3ë‹¨ê³„: ë°±ì—”ë“œ ë°°í¬ (my-node ë³€ê²½ì‹œë§Œ ì‹¤í–‰)
  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ğŸ’› ë°±ì—”ë“œ ì½”ë“œë¥¼ EC2ë¡œ ì§ì ‘ ë³µì‚¬ (SCP)
      - name: Copy backend files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "my-node/*"
          target: "~/apps/my-node/"

      # ğŸ’› EC2ì—ì„œ ì„¤ì¹˜ + ë¹Œë“œ + PM2 ì¬ì‹œì‘
      - name: Execute backend deploy on EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/apps/my-node

            # .env ìœ ì§€
            if [ -f ~/apps/my-node/.env ]; then
              cp ~/apps/my-node/.env .env
            fi

            # íŒ¨í‚¤ì§€ ì„¤ì¹˜
            npm ci

            # ë¹Œë“œ
            npm run build

            # PM2 ì‹¤í–‰/ì¬ì‹¤í–‰
            pm2 restart my-node || pm2 start npm --name "my-node" -- start
            pm2 save

      - name: Verify deployment
        run: |
          sleep 5
          curl -f http://${{ secrets.EC2_HOST }}:8000/health || echo "âš ï¸ Health check failed"

      - name: Success notification
        run: echo "âœ… Backend deployed successfully to EC2!"
